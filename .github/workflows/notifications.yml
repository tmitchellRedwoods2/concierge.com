name: Deployment Notifications

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

jobs:
  notify-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Get workflow run details
      id: get_run_details
      run: |
        echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        echo "commit_message=${{ github.event.workflow_run.head_commit.message }}" >> $GITHUB_OUTPUT
        echo "author_name=${{ github.event.workflow_run.head_commit.author.name }}" >> $GITHUB_OUTPUT
        echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        
    - name: Send Email Notification
      if: env.EMAIL_NOTIFICATIONS == 'true'
      run: |
        echo "ğŸ“§ Email notification would be sent here"
        echo "ğŸ‰ DEPLOYMENT SUCCESS!"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Commit: ${{ steps.get_run_details.outputs.commit_sha }}"
        echo "ğŸ‘¤ Author: ${{ steps.get_run_details.outputs.author_name }}"
        echo "ğŸ“ Message: ${{ steps.get_run_details.outputs.commit_message }}"
        echo "âœ… All tests passed"
        echo "ğŸš€ Streamlit Cloud deployment triggered"
        echo "ğŸŒ Your app should be live shortly!"
        
    - name: Send Slack Notification
      if: env.SLACK_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸ‰ *Concierge.com Deployment Successful!*",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "ğŸ‰ Deployment Successful!"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Commit:*\n`${{ steps.get_run_details.outputs.commit_sha }}`"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Branch:*\n${{ steps.get_run_details.outputs.branch }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Author:*\n${{ steps.get_run_details.outputs.author_name }}"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Status:*\nâœ… All tests passed"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*Message:* ${{ steps.get_run_details.outputs.commit_message }}"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View Deployment"
                  },
                  "url": "${{ steps.get_run_details.outputs.run_url }}",
                  "style": "primary"
                }
              ]
            }
          ]
        }' \
        ${{ env.SLACK_WEBHOOK_URL }}
        
    - name: Send Discord Notification
      if: env.DISCORD_WEBHOOK_URL != ''
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "content": "ğŸ‰ **Concierge.com Deployment Successful!**",
          "embeds": [
            {
              "title": "ğŸš€ Deployment Complete",
              "color": 65280,
              "fields": [
                {
                  "name": "Commit",
                  "value": "`${{ steps.get_run_details.outputs.commit_sha }}`",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "${{ steps.get_run_details.outputs.branch }}",
                  "inline": true
                },
                {
                  "name": "Author",
                  "value": "${{ steps.get_run_details.outputs.author_name }}",
                  "inline": true
                },
                {
                  "name": "Status",
                  "value": "âœ… All tests passed",
                  "inline": true
                },
                {
                  "name": "Message",
                  "value": "${{ steps.get_run_details.outputs.commit_message }}"
                }
              ],
              "footer": {
                "text": "Concierge.com CI/CD Pipeline"
              },
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
            }
          ]
        }' \
        ${{ env.DISCORD_WEBHOOK_URL }}

  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Get workflow run details
      id: get_run_details
      run: |
        echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
        echo "commit_message=${{ github.event.workflow_run.head_commit.message }}" >> $GITHUB_OUTPUT
        echo "author_name=${{ github.event.workflow_run.head_commit.author.name }}" >> $GITHUB_OUTPUT
        echo "run_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
        echo "branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        
    - name: Send Failure Notification
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo "ğŸ“… Date: $(date)"
        echo "ğŸ”— Commit: ${{ steps.get_run_details.outputs.commit_sha }}"
        echo "ğŸ‘¤ Author: ${{ steps.get_run_details.outputs.author_name }}"
        echo "ğŸ“ Message: ${{ steps.get_run_details.outputs.commit_message }}"
        echo "ğŸ’¥ Tests failed or deployment error occurred"
        echo "ğŸ” Check the GitHub Actions logs for details"
        
        # Send Slack notification for failure
        if [ "$SLACK_WEBHOOK_URL" != "" ]; then
          curl -X POST -H 'Content-type: application/json' \
          --data '{
            "text": "âŒ *Concierge.com Deployment Failed!*",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âŒ Deployment Failed!"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`${{ steps.get_run_details.outputs.commit_sha }}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ steps.get_run_details.outputs.branch }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Author:*\n${{ steps.get_run_details.outputs.author_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\nâŒ Tests failed"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Logs"
                    },
                    "url": "${{ steps.get_run_details.outputs.run_url }}",
                    "style": "danger"
                  }
                ]
              }
            ]
          }' \
          ${{ env.SLACK_WEBHOOK_URL }}
        fi
